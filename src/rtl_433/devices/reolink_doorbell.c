/* skylink off-brand wireless motion sensor and alarm system on 433.3MHz
 * Skylink HA-434TL
 *

   This motion sensor is pretty primitive, but the price is good.  It only sends
   messages when it see's motion, and has no motion clear message.  It also does
   not appear to send battery levels or low battery.  It does send regular heartbeats though ( every 2 hours )
pulse_demod_pwm(): Analyzer Device
bitbuffer:: Number of rows: 49 
[00] { 1} 80          : 1
[01] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[02] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[03] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[04] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[05] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[06] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[07] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[08] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[09] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[10] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[11] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[12] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[13] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[14] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[15] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[16] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[17] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[18] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[19] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[20] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[21] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[22] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[23] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[24] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[25] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[26] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[27] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[28] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[29] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[30] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[31] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[32] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[33] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[34] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[35] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[36] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[37] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[38] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[39] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[40] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[41] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[42] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[43] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[44] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[45] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[46] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[47] {25} 5a a6 ad 80 : 01011010 10100110 10101101 1
[48] {24} 5a a6 ad    : 01011010 10100110 10101101 

Detected OOK package	@2.031616s
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
time      : @2.031616s
model     : Akhan-100F14 ID (20bit): 0xa5595
Data (4bit): 0x2 (Unlock)
Analyzing pulses...
Total count:   41,  width: 65.56 ms		(16390 S)
Pulse width distribution:
 [ 0] count:   22,  width:  352 us [348;360]	(  88 S)
 [ 1] count:   18,  width:  956 us [956;968]	( 239 S)
 [ 2] count:    1,  width:   68 us [68;68]	(  17 S)
Gap width distribution:
 [ 0] count:    2,  width: 9344 us [9344;9348]	(2336 S)
 [ 1] count:   18,  width:  252 us [244;260]	(  63 S)
 [ 2] count:   20,  width:  856 us [852;868]	( 214 S)
Pulse period distribution:
 [ 0] count:    2,  width: 9696 us [9696;9700]	(2424 S)
 [ 1] count:   38,  width: 1212 us [1208;1220]	( 303 S)
Pulse timing distribution:
 [ 0] count:   22,  width:  352 us [348;360]	(  88 S)
 [ 1] count:   38,  width:  904 us [852;968]	( 226 S)
 [ 2] count:    1,  width:   68 us [68;68]	(  17 S)
 [ 3] count:    3,  width: 9564 us [9344;10004]	(2391 S)
 [ 4] count:   18,  width:  252 us [244;260]	(  63 S)
Level estimates [high, low]:  15774,    440
RSSI: -0.2 dB SNR: 15.5 dB Noise: -15.7 dB
Frequency offsets [F1, F2]:     939,      0	(+3.6 kHz, +0.0 kHz)
Guessing modulation: Pulse Width Modulation with sync/delimiter
view at https://triq.org/pdv/#AAB00D0501016003880044255C00FC8355+AAB0250501016003880044255C00FC9481948181948194819481949481819481948194818194818355+AAB01B0501016003880044255C00FC9481948181948194819481949481A355
Attempting demodulation... short_width: 352, long_width: 956, reset_limit: 9352, sync_width: 68
Use a flex decoder with -X 'n=name,m=OOK_PWM,s=352,l=956,r=9352,g=0,t=0,y=68'


   new_tmplate callback:

 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 */
#include "decoder.h"

static int reolink_doorbell_callback(r_device* decoder, bitbuffer_t* bitbuffer) {
  data_t* data;
  uint8_t* b;
  int code;
  int raw;
  char code_str[7];
  char raw_str[9];

  for (int i = 0; i < bitbuffer->num_rows; ++i) {
    b = bitbuffer->bb[i];
    if (bitbuffer->bits_per_row[i] ==25)
      continue;

    {
      if (decoder->verbose > 1)
        fprintf(stderr, "%s: rows %d row %i bits %d\n", __func__, bitbuffer->num_rows, i, bitbuffer->bits_per_row[i]);
      // [01] {17} 5a a6 ad 80  : 01011010  10100110 10101101  10000000  -- No motion

      // The last row should be the signal
    //  if (i + 1 != bitbuffer->num_rows) {
      //  continue;
      //}

    //  raw = code = ((b[0]) << 20) | (b[1] << 12) | (b[2] << 4) | (b[3] >> 4);
    //  code = (b[0] << 12) | (b[1] << 4) | (b[2] >> 4);
      raw = code = ((b[0]) << 16) | (b[1] << 8) | (b[2] << 0);
      code = (b[0] << 16) | (b[1] << 8) | (b[2] >> 0);
      if (code != 0x5aa6ad)
        return 0; // Abort early for bad signal

      sprintf(code_str, "%06x", code);
      sprintf(raw_str, "%08x", raw);


      /* Get time now */
      data = data_make(
          "model", "", DATA_STRING, "Reolink-Doorbell",
          "id", "", DATA_STRING, code_str,
          "data", "", DATA_STRING, raw_str,
          NULL);

      decoder_output_data(decoder, data);
      return 1;
    }
  }
  return 0;
}

static char const* output_fields[] = {
    "model",
    "id",
    "data",
    NULL};


r_device const reolink_doorbell = {
        .name        = "Reolink-Doorbell",
        .modulation  = OOK_PULSE_PWM,
        .short_width = 352,
        .long_width  = 956,
        .reset_limit = 9800,
        .gap_limit   = 0,
		.tolerance   = 100,
        .decode_fn   = &reolink_doorbell_callback,
        .fields      = output_fields,
};

